<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Journal - æ—¥å ±å…¥åŠ›</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ Growth Journal</h1>
            <p class="subtitle">æˆé•·ã‚’å¯è¦–åŒ–ã™ã‚‹æ—¥å ±ã‚·ã‚¹ãƒ†ãƒ </p>
        </header>

        <div class="progress-section">
            <div class="progress-card">
                <span class="progress-label">ç¾åœ¨ã®è¨˜éŒ²</span>
                <span class="progress-count">{{ journal_count }} / {{ trigger_count }}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (journal_count / trigger_count * 100) }}%"></div>
            </div>
            <p class="progress-message">
                {% if journal_count == trigger_count - 1 %}
                    ğŸ‰ æ¬¡ã®æ—¥å ±ã§ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼
                {% else %}
                    ã‚ã¨ {{ trigger_count - journal_count }} æ—¥å ±ã§ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
                {% endif %}
            </p>
        </div>

        <div class="form-section">
            <form id="journalForm">
                <div class="form-group">
                    <label for="date">æ—¥ä»˜</label>
                    <input type="date" id="date" name="date" value="{{ today }}" required>
                </div>

                <div class="form-group">
                    <label for="content">ä»Šæ—¥ã®æ´»å‹•</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="12"
                        placeholder="ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã€å­¦ã‚“ã ã“ã¨ã€æ„Ÿã˜ãŸã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„...&#10;&#10;ä¾‹:&#10;- Pythonã§ãƒ‡ãƒ¼ã‚¿åˆ†æã®åŸºç¤ã‚’å­¦ç¿’&#10;- pandasã®groupbyé–¢æ•°ã®ä½¿ã„æ–¹ã‚’ç†è§£&#10;- å¯è¦–åŒ–ã«matplotlibã‚’ä½¿ã£ã¦ã‚°ãƒ©ãƒ•ä½œæˆ&#10;- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§å°‘ã—è©°ã¾ã£ãŸãŒè§£æ±ºã§ããŸ"
                        required
                    ></textarea>
                </div>

                <button type="submit" class="submit-button" id="submitButton">
                    <span class="button-text">æ—¥å ±ã‚’é€ä¿¡</span>
                    <span class="button-loading" style="display: none;">å‡¦ç†ä¸­...</span>
                </button>
            </form>
        </div>

        <div id="result" class="result-section" style="display: none;"></div>
    </div>

    <script>
        const form = document.getElementById('journalForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = submitButton.querySelector('.button-text');
        const buttonLoading = submitButton.querySelector('.button-loading');
        const resultDiv = document.getElementById('result');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            submitButton.disabled = true;
            buttonText.style.display = 'none';
            buttonLoading.style.display = 'inline';

            const formData = new FormData(form);

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result-section success';

                    let html = `
                        <h2>âœ… æ—¥å ±ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼</h2>
                        <div class="result-content">
                            <div class="result-item">
                                <h3>ğŸ“Š AIç”Ÿæˆã‚µãƒãƒªãƒ¼</h3>
                                <p>${data.summary}</p>
                            </div>
                    `;

                    if (data.growth_points && data.growth_points.length > 0) {
                        html += `
                            <div class="result-item">
                                <h3>ğŸŒŸ æˆé•·ãƒã‚¤ãƒ³ãƒˆ</h3>
                                <ul>
                                    ${data.growth_points.map(point => `<li>${point}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (data.skills && data.skills.length > 0) {
                        html += `
                            <div class="result-item">
                                <h3>ğŸ·ï¸ æ¤œå‡ºã•ã‚ŒãŸã‚¹ã‚­ãƒ«</h3>
                                <div class="skills-tags">
                                    ${data.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (data.should_reflect) {
                        html += `
                            <div class="reflection-notice">
                                <h3>ğŸ‰ ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆã®æ™‚é–“ã§ã™ï¼</h3>
                                <p>${data.journal_count}æ—¥åˆ†ã®æ—¥å ±ãŒè²¯ã¾ã‚Šã¾ã—ãŸã€‚æˆé•·ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†ã€‚</p>
                                <a href="${data.reflection_url}" class="reflection-button">ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹</a>
                            </div>
                        `;
                    }

                    html += `
                            <p class="journal-count">è¨˜éŒ²: ${data.journal_count}æ—¥ç›®</p>
                        </div>
                    `;

                    resultDiv.innerHTML = html;

                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    form.reset();
                    document.getElementById('date').value = '{{ today }}';

                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ï¼‰
                    if (data.should_reflect) {
                        setTimeout(() => {
                            window.location.href = data.reflection_url;
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    }
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result-section error';
                    resultDiv.innerHTML = `
                        <h2>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                        <p>${data.error}</p>
                    `;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result-section error';
                resultDiv.innerHTML = `
                    <h2>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                    <p>${error.message}</p>
                `;
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                submitButton.disabled = false;
                buttonText.style.display = 'inline';
                buttonLoading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
